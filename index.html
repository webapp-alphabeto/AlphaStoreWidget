<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alphabeto Store Locator Widget</title>
    
    <!-- React e React DOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilos customizados para o widget */
        .alphabeto-widget-container {
            position: fixed;
            z-index: 999999;
        }
        
        .alphabeto-widget-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999999;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border: none;
            cursor: pointer;
        }
        
        .alphabeto-widget-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .alphabeto-widget-modal {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 100%;
            max-width: 384px;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 999999;
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .alphabeto-widget-modal.closed {
            transform: translateX(100%);
        }
        
        .alphabeto-widget-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999998;
        }
        
        @media (max-width: 640px) {
            .alphabeto-widget-modal {
                max-width: 100%;
            }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #FF6B35;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Container do Widget -->
    <div id="alphabeto-store-locator-widget"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Componente do Widget
        const AlphabetoStoreLocatorWidget = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [currentView, setCurrentView] = useState('menu'); // menu, loading, results
            const [addressInput, setAddressInput] = useState('');
            const [nearbyStores, setNearbyStores] = useState([]);
            const [allStores, setAllStores] = useState([]);
            const [sacInfo, setSacInfo] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [storesLoaded, setStoresLoaded] = useState(false);

            // Carregar lojas do arquivo JSON
            useEffect(() => {
                fetch('stores.json')
                    .then(response => response.json())
                    .then(data => {
                        setAllStores(data.stores || []);
                        setSacInfo(data.sac || null);
                        setStoresLoaded(true);
                    })
                    .catch(error => {
                        console.error('Erro ao carregar lojas:', error);
                        // Fallback para algumas lojas
                        setAllStores([
                            { id: 37, name: "Alphabeto Alian√ßa Shopping", address: "Pra√ßa Doutor Augusto Gl√≥ria, 327 - Centro", city: "S√£o Jo√£o Nepomuceno", state: "MG", cep: "36680-000", whatsapp: "5532991295904", lat: -21.5388, lng: -43.0089, hours: "Seg-S√°b: 9h-18h | Dom: 9h-14h" },
                            { id: 31, name: "Alphabeto Barra Shopping", address: "Avenida das Am√©ricas, 4666 - Barra da Tijuca", city: "Rio de Janeiro", state: "RJ", cep: "22640-102", whatsapp: "5521996628735", lat: -23.0049, lng: -43.3211, hours: "Seg-S√°b: 10h-22h | Dom: 13h-21h" },
                            { id: 6, name: "Alphabeto Morumbi Shopping", address: "Avenida Roque Petroni J√∫nior, 1089 - Vila Gertrudes", city: "S√£o Paulo", state: "SP", cep: "04707-900", whatsapp: "5511930402110", lat: -23.6224, lng: -46.6993, hours: "Seg-S√°b: 10h-22h | Dom: 14h-20h" }
                        ]);
                        setSacInfo({ name: "Fadinhas do SAC", whatsapp: "5521999999999", message: "Ol√°! Gostaria de falar com as Fadinhas do SAC da Alphabeto! üßö‚Äç‚ôÄÔ∏è" });
                        setStoresLoaded(true);
                    });
            }, []);

            // Calcular dist√¢ncia entre duas coordenadas
            const calculateDistance = (lat1, lng1, lat2, lng2) => {
                const R = 6371; // Raio da Terra em km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            };

            // Formatar CEP
            const formatCEP = (cep) => {
                return cep.replace(/\D/g, '');
            };

            // Verificar se √© CEP
            const isCEP = (value) => {
                const cleaned = formatCEP(value);
                return cleaned.length === 8 && /^\d{8}$/.test(cleaned);
            };

            // Usar geolocaliza√ß√£o
            const useCurrentLocation = async () => {
                setIsLoading(true);
                setCurrentView('loading');
                
                try {
                    const position = await new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            reject(new Error("Geolocaliza√ß√£o n√£o suportada"));
                            return;
                        }
                        
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });

                    const { latitude, longitude } = position.coords;
                    const storesWithDistance = allStores.map(store => ({
                        ...store,
                        distance: calculateDistance(latitude, longitude, store.lat, store.lng)
                    })).sort((a, b) => a.distance - b.distance);
                    
                    setNearbyStores(storesWithDistance);
                    setCurrentView('results');
                    
                } catch (error) {
                    let message = "N√£o foi poss√≠vel obter sua localiza√ß√£o.";
                    if (error.code === 1) {
                        message = "Permiss√£o de localiza√ß√£o negada. Por favor, digite seu endere√ßo.";
                    } else if (error.code === 2) {
                        message = "Localiza√ß√£o indispon√≠vel. Verifique se o GPS est√° ativado.";
                    } else if (error.code === 3) {
                        message = "Tempo esgotado. Tente novamente ou digite seu endere√ßo.";
                    }
                    alert(message);
                    setCurrentView('menu');
                }
                
                setIsLoading(false);
            };

            // Buscar endere√ßo via ViaCEP
            const searchViaCEP = async (cep) => {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    
                    if (!data.erro) {
                        return `${data.logradouro}, ${data.localidade}, ${data.uf}, Brasil`;
                    }
                    return null;
                } catch (error) {
                    return null;
                }
            };

            // Geocodificar endere√ßo
            const geocodeAddress = async (address) => {
                const searchAddress = `${address}, Brasil`;
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchAddress)}&countrycodes=br&limit=1`
                );
                
                const data = await response.json();
                
                if (data && data[0]) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                
                throw new Error('Endere√ßo n√£o encontrado');
            };

            // Buscar lojas por endere√ßo
            const findNearbyStores = async () => {
                if (!addressInput.trim()) {
                    alert("Por favor, digite seu endere√ßo, cidade ou CEP.");
                    return;
                }

                setIsLoading(true);
                setCurrentView('loading');
                
                try {
                    let searchAddress = addressInput;
                    
                    // Se for CEP, buscar endere√ßo completo
                    if (isCEP(addressInput)) {
                        const cepFormatted = formatCEP(addressInput);
                        const viacepAddress = await searchViaCEP(cepFormatted);
                        if (viacepAddress) {
                            searchAddress = viacepAddress;
                        } else {
                            searchAddress = addressInput + ', Brasil';
                        }
                    }
                    
                    const coordinates = await geocodeAddress(searchAddress);
                    
                    const storesWithDistance = allStores.map(store => ({
                        ...store,
                        distance: calculateDistance(coordinates.lat, coordinates.lng, store.lat, store.lng)
                    })).sort((a, b) => a.distance - b.distance);
                    
                    setNearbyStores(storesWithDistance);
                    setCurrentView('results');
                } catch (error) {
                    alert("N√£o foi poss√≠vel encontrar o endere√ßo. Tente ser mais espec√≠fico.");
                    setCurrentView('menu');
                }
                
                setIsLoading(false);
            };

            // Abrir WhatsApp
            const openWhatsApp = (store) => {
                const now = new Date();
                const hour = now.getHours();
                
                let greeting = "Ol√°!";
                if (hour < 12) greeting = "Bom dia!";
                else if (hour < 18) greeting = "Boa tarde!";
                else greeting = "Boa noite!";
                
                const message = `${greeting} üë∂\n\nGostaria de mais informa√ß√µes sobre a ${store.name}!\n\nEndere√ßo: ${store.address}`;
                const whatsappUrl = `https://wa.me/${store.whatsapp}?text=${encodeURIComponent(message)}`;
                
                window.open(whatsappUrl, '_blank');
            };

            // Abrir WhatsApp SAC
            const openSACWhatsApp = () => {
                if (!sacInfo) return;
                
                const whatsappUrl = `https://wa.me/${sacInfo.whatsapp}?text=${encodeURIComponent(sacInfo.message)}`;
                window.open(whatsappUrl, '_blank');
            };

            // Fechar modal ao clicar fora
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (isOpen && !event.target.closest('.alphabeto-widget-modal') && !event.target.closest('.alphabeto-widget-button')) {
                        setIsOpen(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [isOpen]);

            // Reset ao fechar
            useEffect(() => {
                if (!isOpen) {
                    setTimeout(() => {
                        setCurrentView('menu');
                        setAddressInput('');
                        setNearbyStores([]);
                    }, 300);
                }
            }, [isOpen]);

            return (
                <>
                    {/* Bot√£o Flutuante */}
                    <button
                        onClick={() => setIsOpen(true)}
                        className="alphabeto-widget-button"
                        aria-label="Encontrar loja Alphabeto"
                    >
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                            <path d="M3 21h18M3 7v1a3 3 0 0 0 6 0V7m0 1a3 3 0 0 0 6 0V7m0 1a3 3 0 0 0 6 0V7H3l2-4h14l2 4M5 21V10.85M19 21V10.85"/>
                        </svg>
                        <div style={{
                            position: 'absolute',
                            top: '-4px',
                            right: '-4px',
                            width: '12px',
                            height: '12px',
                            background: '#22c55e',
                            borderRadius: '50%',
                            animation: 'pulse 2s infinite'
                        }}></div>
                    </button>

                    {/* Modal */}
                    <div className={`alphabeto-widget-modal ${!isOpen ? 'closed' : ''}`}>
                        {/* Header */}
                        <div style={{
                            background: 'linear-gradient(to right, #FF6B35, #F7931E)',
                            color: 'white',
                            padding: '16px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between'
                        }}>
                            <h2 style={{ fontSize: '20px', fontWeight: 'bold' }}>Lojas Alphabeto</h2>
                            <button
                                onClick={() => setIsOpen(false)}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    color: 'white',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    fontSize: '24px'
                                }}
                            >
                                ‚úï
                            </button>
                        </div>

                        {/* Conte√∫do */}
                        <div style={{ height: 'calc(100% - 64px)', overflowY: 'auto', padding: '24px' }}>
                            {!storesLoaded ? (
                                <div style={{ textAlign: 'center', padding: '40px' }}>
                                    <div className="spinner" style={{ margin: '0 auto' }}></div>
                                    <p style={{ marginTop: '16px', color: '#6b7280' }}>
                                        Carregando lojas...
                                    </p>
                                </div>
                            ) : currentView === 'loading' ? (
                                <div style={{ textAlign: 'center', padding: '40px' }}>
                                    <div className="spinner" style={{ margin: '0 auto' }}></div>
                                    <p style={{ marginTop: '16px', color: '#6b7280' }}>
                                        Buscando lojas pr√≥ximas...
                                    </p>
                                </div>
                            ) : currentView === 'menu' ? (
                                <>
                                    <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '24px' }}>
                                        Encontre a loja mais pr√≥xima
                                    </h3>
                                    
                                    {/* Bot√£o de geolocaliza√ß√£o */}
                                    <button
                                        onClick={useCurrentLocation}
                                        style={{
                                            width: '100%',
                                            padding: '14px',
                                            background: 'linear-gradient(to right, #FF6B35, #F7931E)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontSize: '16px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            marginBottom: '12px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '8px'
                                        }}
                                    >
                                        üìç Usar minha localiza√ß√£o atual
                                    </button>

                                    <div style={{ textAlign: 'center', margin: '16px 0', color: '#6b7280' }}>
                                        ou
                                    </div>
                                    
                                    {/* Campo de busca */}
                                    <input
                                        type="text"
                                        placeholder="Digite sua cidade, CEP ou endere√ßo..."
                                        value={addressInput}
                                        onChange={(e) => setAddressInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && findNearbyStores()}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            border: '2px solid #fed7aa',
                                            borderRadius: '8px',
                                            marginBottom: '12px',
                                            fontSize: '16px'
                                        }}
                                    />
                                    
                                    <button
                                        onClick={findNearbyStores}
                                        disabled={isLoading}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            background: 'white',
                                            color: '#FF6B35',
                                            border: '2px solid #FF6B35',
                                            borderRadius: '8px',
                                            fontSize: '16px',
                                            fontWeight: 'bold',
                                            cursor: isLoading ? 'not-allowed' : 'pointer',
                                            opacity: isLoading ? 0.5 : 1
                                        }}
                                    >
                                        üîç Buscar lojas
                                    </button>

                                    {/* Bot√£o das Fadinhas */}
                                    {sacInfo && (
                                        <>
                                            <div style={{ height: '1px', background: '#e5e7eb', margin: '24px 0' }}></div>
                                            <button
                                                onClick={openSACWhatsApp}
                                                style={{
                                                    width: '100%',
                                                    padding: '14px',
                                                    background: 'linear-gradient(to right, #8B5CF6, #EC4899)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '8px',
                                                    fontSize: '16px',
                                                    fontWeight: 'bold',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '8px'
                                                }}
                                            >
                                                üßö‚Äç‚ôÄÔ∏è Falar com as Fadinhas do SAC
                                            </button>
                                        </>
                                    )}

                                    {/* Lista de todas as lojas */}
                                    <div style={{ marginTop: '32px' }}>
                                        <h4 style={{ fontSize: '16px', fontWeight: 'bold', marginBottom: '16px' }}>
                                            Todas as lojas
                                        </h4>
                                        {allStores.slice(0, 10).map((store) => (
                                            <div
                                                key={store.id}
                                                onClick={() => openWhatsApp(store)}
                                                style={{
                                                    border: '1px solid #e5e7eb',
                                                    borderRadius: '8px',
                                                    padding: '16px',
                                                    marginBottom: '12px',
                                                    cursor: 'pointer',
                                                    transition: 'background 0.2s'
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.background = '#f9fafb'}
                                                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                                            >
                                                <h5 style={{ fontWeight: 'bold', marginBottom: '4px' }}>{store.name}</h5>
                                                <p style={{ fontSize: '14px', color: '#6b7280' }}>
                                                    {store.city}, {store.state}
                                                </p>
                                                <p style={{ fontSize: '12px', color: '#9ca3af', marginTop: '4px' }}>
                                                    {store.address}
                                                </p>
                                                {store.cep && (
                                                    <p style={{ fontSize: '11px', color: '#9ca3af', marginTop: '2px' }}>
                                                        CEP: {store.cep}
                                                    </p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                <>
                                    {/* Resultados */}
                                    <button
                                        onClick={() => setCurrentView('menu')}
                                        style={{
                                            color: '#FF6B35',
                                            fontWeight: 'bold',
                                            marginBottom: '16px',
                                            background: 'none',
                                            border: 'none',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '4px'
                                        }}
                                    >
                                        ‚Üê Voltar
                                    </button>
                                    
                                    <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '8px' }}>
                                        Lojas encontradas
                                    </h3>
                                    <p style={{ color: '#6b7280', marginBottom: '24px' }}>
                                        Ordenadas por proximidade
                                    </p>
                                    
                                    {nearbyStores.length === 0 ? (
                                        <div style={{ textAlign: 'center', padding: '40px' }}>
                                            <p style={{ fontSize: '48px', marginBottom: '16px' }}>üòî</p>
                                            <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '8px' }}>
                                                Nenhuma loja encontrada
                                            </h3>
                                            <p style={{ color: '#6b7280' }}>
                                                Tente buscar por outra localiza√ß√£o
                                            </p>
                                        </div>
                                    ) : (
                                        nearbyStores.map((store, index) => (
                                            <div
                                                key={store.id}
                                                onClick={() => openWhatsApp(store)}
                                                style={{
                                                    border: index === 0 && store.distance < 50 ? '2px solid #FF6B35' : '1px solid #e5e7eb',
                                                    borderRadius: '8px',
                                                    padding: '16px',
                                                    marginBottom: '12px',
                                                    cursor: 'pointer',
                                                    background: index === 0 && store.distance < 50 ? '#fff7ed' : 'white',
                                                    position: 'relative'
                                                }}
                                                onMouseEnter={(e) => {
                                                    if (!(index === 0 && store.distance < 50)) {
                                                        e.currentTarget.style.background = '#f9fafb';
                                                    }
                                                }}
                                                onMouseLeave={(e) => {
                                                    if (!(index === 0 && store.distance < 50)) {
                                                        e.currentTarget.style.background = 'white';
                                                    }
                                                }}
                                            >
                                                {index === 0 && store.distance < 50 && (
                                                    <span style={{
                                                        display: 'inline-block',
                                                        background: '#FF6B35',
                                                        color: 'white',
                                                        fontSize: '12px',
                                                        padding: '2px 8px',
                                                        borderRadius: '9999px',
                                                        marginBottom: '8px'
                                                    }}>
                                                        Mais pr√≥xima
                                                    </span>
                                                )}
                                                
                                                <div style={{ 
                                                    position: 'absolute',
                                                    top: '16px',
                                                    right: '16px',
                                                    fontWeight: 'bold',
                                                    color: '#FF6B35'
                                                }}>
                                                    {store.distance.toFixed(1)} km
                                                </div>
                                                
                                                <h5 style={{ fontWeight: 'bold', marginBottom: '4px' }}>{store.name}</h5>
                                                <p style={{ fontSize: '14px', color: '#6b7280' }}>
                                                    {store.city}, {store.state}
                                                </p>
                                                <p style={{ fontSize: '12px', color: '#9ca3af', marginTop: '4px' }}>
                                                    {store.address}
                                                </p>
                                                {store.cep && (
                                                    <p style={{ fontSize: '11px', color: '#9ca3af', marginTop: '2px' }}>
                                                        CEP: {store.cep}
                                                    </p>
                                                )}
                                                {store.hours && (
                                                    <p style={{ fontSize: '12px', color: '#6b7280', marginTop: '8px' }}>
                                                        ‚è∞ {store.hours.split('|')[0]}
                                                    </p>
                                                )}
                                                <div style={{ 
                                                    marginTop: '8px',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '4px',
                                                    color: '#22c55e'
                                                }}>
                                                    üí¨ WhatsApp
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </>
                            )}
                        </div>
                    </div>

                    {/* Overlay para mobile */}
                    {isOpen && window.innerWidth < 640 && (
                        <div 
                            className="alphabeto-widget-overlay"
                            onClick={() => setIsOpen(false)}
                        ></div>
                    )}

                    <style>{`
                        @keyframes pulse {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.5; }
                        }
                    `}</style>
                </>
            );
        };

        // Renderizar o widget
        ReactDOM.render(<AlphabetoStoreLocatorWidget />, document.getElementById('alphabeto-store-locator-widget'));
    </script>

    <!-- Babel Transpiler -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>